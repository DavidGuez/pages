<input type="hidden" id="partial_title" value="Primaire ouverte pour les Législatives de 2017">
<input type="hidden" id="num_circonscription" value="<%= circonscription['num_circonscription'] %>">
<input type="hidden" id="num_departement" value="<%= circonscription['departement'] %>">
<input type="hidden" id="circonscription_id" value="<%= circonscription['id'] %>">
<style>
    .independant {display:none;}
</style>
    <div class="row">
        <div class="col-md-12">
            <ul class="stepper stepper-horizontal">
                <li class="completed active grey lighten-3">
                    <a href="#!">
                        <span class="circle">1</span>
                        <span class="label">Qualification <i  style="color:#ffbb33;" class="fa fa-cog" aria-hidden="true"></i></span>
                    </a>
                </li>
                <li>
                    <a href="#!">
                        <span class="circle">2</span>
                        <span class="label">Vote</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="circle">3</span>
                        <span class="label">Résultats</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div id="legislatives-2017-1" class="step" style="display:visible;">
        <h2 class="h2-responsive doc-title">Du 21 février au 15 avril 2017</h2>
        <p class="text-justify">Afin de se qualifier, un(e) candidat(e) doit recueillir au moins X soutiens de citoyen(ne)s. Un(e) citoyen(ne) ne peut soutenir que 3 candidat(e)s au maximum.</p>
        <h2 class="h2-responsive doc-title"><%= circonscription['name_circonscription'] %></h2>
        <h3 class="h4-responsive doc-title">Député(e) actuel(le)</h3>
        <a href="<%= circonscription['deputy_url'] %>" target="_blank">
            <img src="https://www.nosdeputes.fr/depute/photo/<%= circonscription['deputy_slug'] %>/100" style="float:left;">
        </a>
        &nbsp;<b><%= circonscription['deputy_name'] %></b><br/>
        &nbsp;<%= circonscription['deputy_party'] %><br/>
        &nbsp;<%= circonscription['deputy_job'] %>
        <div class="clearfix" style="margin-bottom:15px;"></div>
        <h3 class="h4-responsive doc-title">Les candidats</h3>
        <div class="container-fluid">
                <div id="hits"></div>
        </div>
        <div id="num_departement" style="display:none;"></div>
        <div id="num_circonscription" style="display:none;"></div>
    </div>

<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/instantsearch.js/1/instantsearch.min.css">
<script src="https://cdn.jsdelivr.net/instantsearch.js/1/instantsearch.min.js"></script>
<script>
function support_candidate(slug) {
    if ($('#support-'+slug).hasClass('btn-outline-primary')) {
        $.post('/citoyen/api/<%= citoyen['slug'] %>/'+slug+'/support',{'election'=>'legislatives-2017'});
        $('#support-'+slug).removeClass('btn-outline-primary');
        $('#support-'+slug).addClass('btn-primary');
        $('#support-'+slug).html('Soutenu(e)');
        toastr.success('Soutien bien enregistré','Merci',{positionClass: 'toast-bottom-right'});
    } else {
        $.post('/citoyen/api/<%= citoyen['slug'] %>/'+slug+'/unsupport',{'election'=>'legislatives-2017'});
        $('#support-'+slug).removeClass('btn-primary');
        $('#support-'+slug).addClass('btn-outline-primary');
        $('#support-'+slug).html('Soutenir');
        toastr.info('Soutien supprimé','Bien reçu',{positionClass: 'toast-bottom-right'});
    }
}
</script>
<script type="text/html" id="hit-template">
        <div class="card">
            <div class="view overlay hm-white-slight">
                <div style="position:absolute;z-index:1000;left:0px;">
                    <span class="badge red">dept {{num_departement}}</span>
                    <span class="badge green">circo {{num_circonscription}}</span>
                </div>
                <div style="position:absolute;z-index:1000;bottom:0px;bottom:-8px;left:8px;" class="{{supported_candidate_visibility}}">
                        
                    <div class="chip" title="Je soutiens {{supported_candidate}}">
                        <img style="float:right;margin:0 -12px 0 8px;" src="https://s3.eu-central-1.amazonaws.com/laprimaire/candidats/{{supported_candidate_photo}}"> Je soutiens
                    </div>
                </div>
                <img class="img-fluid img-thumbnail" src="https://s3.eu-central-1.amazonaws.com/{{photo}}" alt="{{{_highlightResult.name.value}}}">
                <a href="#">
                    <div class="mask waves-effect waves-light"></div>
                </a>
            </div>
            <div class="progress" style="height:8px;">
                <div class="progress-bar bg-success" role="progressbar" style="height:8px;width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" title="25/100"></div>
            </div>
            <div class="card-block" style="padding:0.8em;">
                <h5 class="card-title text-center" style="margin-bottom:0px;">{{{_highlightResult.name.value}}}</h5>
                <p style="font-size:0.7em;text-align:center;margin-bottom:0.5em;">Candidat depuis {{nb_days_verified}} jours</p>
                <div class="text-center">
                    <button id="support-{{slug}}" type="button" onclick="support_candidate('{{slug}}');" class="support-candidate text-center btn btn-outline-primary waves-effect" autocomplete="off">Soutenir</button>
                </div>
            </div>
        </div><br/>
</script>
<script>
function shuffle (o){
	  for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
	    return o;
}
function getTemplate(templateName) {
  return document.getElementById(templateName + '-template').innerHTML;
}
    
$.getScript('https://cdn.jsdelivr.net/instantsearch.js/1/instantsearch.min.js')
.done(function(script,status) {
    var search = instantsearch({
        appId: 'D1XVECSSVA',
        apiKey: '58643f9dff29db9f8da06875479fb290',
        indexName: 'candidats_legislatives',
        urlSync: false
    });
    search.addWidget(
        instantsearch.widgets.menu({
        container: '#num_departement',
        attributeName: 'num_departement',
        sortBy: ['num_departement:asc'],
        autoHideContainer: false,
        collapsible: true,
        limit: 105,
        cssClasses: {
            header:'lp-cat-header',
            item:'lp-cat-item',
            checkbox:'lp-cat-checkbox',
            label:'lp-cat-label',
            active:'lp-cat-active',
            count:'lp-cat-count'
        },
        templates: {
            header: 'Département',
            item: 'département {{name}} ({{count}})'
        }
    })
    );
    search.addWidget(
        instantsearch.widgets.menu({
        container: '#num_circonscription',
        attributeName: 'num_circonscription',
        sortBy: ['num_circonscription:asc'],
        limit: 105,
        autoHideContainer: false,
        collapsible: true,
        cssClasses: {
            header:'lp-cat-header',
            item:'lp-cat-item',
            checkbox:'lp-cat-checkbox',
            label:'lp-cat-label',
            active:'lp-cat-active',
            count:'lp-cat-count'
        },
        templates: {
            header: 'Circonscription',
            item: 'circonscription {{name}} ({{count}})'
        }
    })
    );
    search.addWidget(
        instantsearch.widgets.hits({
            container: '#hits',
            transformData: {
                allItems: function (content) {
                    return { hits: shuffle(content.hits) };
                }
            },
            templates: {
                   item: getTemplate('hit')
            },
            cssClasses: {
                item: 'col-lg-2 col-md-4 col-sm-6 col-xs-12',
                root: 'row'
            },
            hitsPerPage: 10
        })
    );
//    var num_dept=$('#num_departement').val();
//    var num_circo=$('#num_circonscription').val();
    var num_dept='72';
    var num_circo='3';
    if (!!num_dept) {
        search.searchParameters={
                hierarchicalFacetsRefinements: { // menu is implemented as a hierarchicalFacetsRefinements
                    num_departement: [num_dept],
                    num_circonscription: [num_circo]
            }
        }
    }
    search.start();     
    $(function () {
      $('[data-toggle="popover"]').popover()
    })

});
</script>

