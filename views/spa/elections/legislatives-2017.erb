<input type="hidden" id="partial_title" value="Primaire ouverte pour les Législatives de 2017">
<input type="hidden" id="election_slug" value="<%= circonscription['election_slug'] %>">
<style>
    .independant {display:none;}
</style>
    <div class="row">
        <div class="col-md-12">
            <ul class="stepper stepper-horizontal">
                <li class="completed active grey lighten-3">
                    <a href="#!">
                        <span class="circle">1</span>
                        <span class="label">Qualification <i  style="color:#ffbb33;" class="fa fa-cog" aria-hidden="true"></i></span>
                    </a>
                </li>
                <li>
                    <a href="#!">
                        <span class="circle">2</span>
                        <span class="label">Vote</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="circle">3</span>
                        <span class="label">Résultats</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div id="legislatives-2017-1" class="step" style="display:visible;">
        <h2 class="h2-responsive doc-title">Du 21 février au 15 avril 2017</h2>
        <p class="text-justify">Afin de se qualifier, un(e) candidat(e) doit recueillir au moins X soutiens de citoyen(ne)s. Un(e) citoyen(ne) ne peut soutenir que 3 candidat(e)s au maximum.</p>
        <h2 class="h2-responsive doc-title"><%= circonscription['name_circonscription'] %></h2>
        <h3 class="h4-responsive doc-title">Député(e) actuel(le)</h3>
        <a href="<%= circonscription['deputy_url'] %>" target="_blank">
            <img src="https://www.nosdeputes.fr/depute/photo/<%= circonscription['deputy_slug'] %>/100" style="float:left;">
        </a>
        &nbsp;<b><%= circonscription['deputy_name'] %></b><br/>
        &nbsp;<%= circonscription['deputy_party'] %><br/>
        &nbsp;<%= circonscription['deputy_job'] %>
        <div class="clearfix" style="margin-bottom:15px;"></div>
        <h3 class="h4-responsive doc-title">Les candidats</h3>
        <div class="container-fluid">
		<div id="hits" class="row">
		</div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.js"></script>
<script type="text/html" id="hit-template">
	{{#candidates}}
        <div class="card">
            <div class="view overlay hm-white-slight">
                <div style="position:absolute;z-index:1000;left:0px;">
                    <span class="badge red">dept {{departement}}</span>
                    <span class="badge green">circo {{num_circonscription}}</span>
                </div>
		    {{#fields.candidate}} 
                <div style="position:absolute;z-index:1000;bottom:0px;bottom:-8px;left:8px;" class="{{supported_candidate_visibility}}">
                    <div class="chip" title="Je soutiens {{supported_candidate}}">
                        <img style="float:right;margin:0 -12px 0 8px;" src="https://s3.eu-central-1.amazonaws.com/laprimaire/candidats/{{supported_candidate_photo}}"> Je soutiens
                    </div>
                </div>
                    {{/fields.candidate}} 
                <img class="img-fluid img-thumbnail" src="https://s3.eu-central-1.amazonaws.com/{{photo}}" alt="{{name}}">
                <a href="#">
                    <div class="mask waves-effect waves-light"></div>
                </a>
            </div>
            <div class="progress" style="height:8px;">
                <div class="progress-bar bg-success" role="progressbar" style="height:8px;width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" title="25/100"></div>
            </div>
            <div class="card-block" style="padding:0.8em;">
                <h5 class="card-title text-center" style="margin-bottom:0px;">{{name}}</h5>
                <div class="text-center">
		{{^support_date}}
                    <button id="support-{{slug}}" type="button" onclick="support_candidate('{{slug}}');" class="support-candidate text-center btn btn-outline-primary waves-effect" autocomplete="off">Soutenir</button>
		{{/support_date}}
		{{#support_date}}
                    <button id="support-{{slug}}" type="button" onclick="support_candidate('{{slug}}');" class="support-candidate text-center btn btn-primary waves-effect" autocomplete="off">Soutenu(e)</button>
		{{/support_date}}
                </div>
            </div>
        </div><br/>
	{{/candidates}}
	{{^candidates}}
Aucun(e) candidat(e) pour le moment
	{{/candidates}}
</script>
<script>
function support_candidate(candidate_slug) {
	var election_slug=$('#election_slug').val();
	if ($('#support-'+candidate_slug).hasClass('btn-outline-primary')) {
		$.post('/api/citizen/<%= citoyen['user_key'] %>/election/'+election_slug+'/support/'+candidate_slug, function() {
			$('#support-'+candidate_slug).removeClass('btn-outline-primary');
			$('#support-'+candidate_slug).addClass('btn-primary');
			$('#support-'+candidate_slug).html('Soutenu(e)');
			toastr.success('Soutien bien enregistré','Merci',{positionClass: 'toast-bottom-right'});
		})
		.fail(function(data) { show_notification(data); });
	} else {
		$.post('/api/citizen/<%= citoyen['user_key'] %>/election/'+election_slug+'/unsupport/'+candidate_slug, function() {
			$('#support-'+candidate_slug).removeClass('btn-primary');
			$('#support-'+candidate_slug).addClass('btn-outline-primary');
			$('#support-'+candidate_slug).html('Soutenir');
			toastr.info('Soutien supprimé','Bien reçu',{positionClass: 'toast-bottom-right'});
		})
		.fail(function(data) { show_notification(data); });
	}
}

function pageReady() {
		$.getScript('https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.js')
		.done(function(script,status) {
			var election_slug=$('#election_slug').val();
			$.get('/api/citizen/<%= citoyen['user_key'] %>/election/'+election_slug+'/candidates')
				.done(function(data) {
					var t=$('#hit-template').html();
					Mustache.parse(t);
					var rendered=Mustache.render(t,JSON.parse(data));
					$('#hits').html(rendered);
				})
			.fail(function(data) {
				show_notification(data);
			});
		})
		.fail(function(data) {
			show_notification(data);
		});
}
</script>

